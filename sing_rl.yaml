description: cs336_rl

target:
  service: sing
  workspace_name: srgxws
  name: msrresrchbasicvc

environment:
  image: amlt-sing/acpt-torch2.7.1-py3.10-cuda12.6-ubuntu22.04
  setup:
  - sudo apt update
  - python -m pip install --upgrade pip
  
code:
  local_dir: $CONFIG_DIR/assignment5-alignment
  ignore:
  - checkpoints/
  - .venv/
  - swanlog/
  - "*.log"
  - tests/_snapshots/
  - tests/fixtures/
  - output.txt
  - data/math_hf/train_math_responses.jsonl

data:
    local_dir: $CONFIG_DIR/assignment5-alignment/checkpoints/sft_correct
    remote_dir: data/cs336/assignment5-alignment/checkpoints/sft_correct

search:
  job_template:
    # you may use {random_string:s} to avoid job name collisions
    # {auto:3s} generates lr_0.00000_mom_0.5, .. etc
    # {auto:2s} generates lr_0.00000_mo_0.5, .. etc
    name: "{experiment_name:s}_{auto:3s}"
    sku: 80G1
    identity: managed
    submit_args:
      env:
        NCCL_DEBUG: "ERROR"
        _AZUREML_SINGULARITY_JOB_UAI: /subscriptions/e546c811-2312-46e2-9fd0-c949c65da4d9/resourcegroups/srgx/providers/Microsoft.ManagedIdentity/userAssignedIdentities/srgxuai
    command:
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - source $$HOME/.local/bin/env
    - uv python install 3.12
    - uv sync
    - uv run cs336_alignment/rl.py --config config/rl.yml --train_batch_size {train_batch_size} --gradient_accumulation_steps {train_batch_size} --epochs_per_rollout_batch {epochs_per_rollout_batch} --learning_rate {learning_rate}
  type: grid  # hyperparameter search type: hyperdrive, random, grid.  Default: hyperdrive
  sampling: random  # how to explore the hyperparameter space: random, grid or bayesian. Default: bayesian
  max_trials: 8
  parallel_trials: 8  # number of trials to run in parallel. Default: equals to max_trials.
  params:
    - name: train_batch_size
      values: [64, 128]
    - name: learning_rate
      # spec: hyperdrive  # the default value
      values: [1e-5, 5e-6]
    - name: epochs_per_rollout_batch
      values: [2,4]